#!/bin/sh
#
# Simple installer for ff release image
# Verifies checksum, copies to right places and updates nvram
#
# usage: ffinstall image-file sha256sum
#
#
export FFRITZ_HOME=/var/media/ftp/ffritz

UCLIB_VERSION=`ls /lib/libuClibc-* | sed -e 's/.*-\([0-9]\).*/\1/'`

REL=
if [ $UCLIB_VERSION -gt 0 ]; then
	REL=-${UCLIB_VERSION}
fi

DATADIR=$FFRITZ_HOME/data
TMPDIR=$DATADIR/tmp
BINFILE=$DATADIR/ffimage${REL}.bin
CSUMFILE=/var/tmp/ffnvram/ffimage${REL}.sha256

if [ "$1" = "" -o "$2" = "" ]; then
	echo "usage: $0 release-image sha256sum"
	echo "       release-image can be relative to /var/media/ftp"
	exit 1
fi

if [ -f $1 ]; then
	relfile=$1
elif [ -f /var/media/ftp/$1 ]; then
	relfile=/var/media/ftp/$1
else
	echo usage: $0 release-image
	exit 1
fi

csum=$2

rm -rf ${TMPDIR}
mkdir -p ${TMPDIR} || exit 1

echo +++ Unpacking
tar -x -C ${TMPDIR} -f $relfile || exit 1

echo +++ Verifying compatibility

if [ -r ${TMPDIR}/uclib-version ]; then
	nver=`cat ${TMPDIR}/uclib-version`
else
	nver=0
fi

if [ $nver -ne ${UCLIB_VERSION} ]; then
	echo FAILED: Expected uClibc major version ${UCLIB_VERSION}, image is for $nver
	exit 1
fi

echo +++ Verifying sha256sum

FSIG=`cat ${TMPDIR}/ffimage.sha256sum`
VSIG=`openssl dgst -sha256 ${TMPDIR}/ffimage.bin | sed -e 's/.* //'`

if [ "$VSIG" != "$FSIG" ]; then
	echo " Does not match, expected $FSIG, got $VSIG"
	exit 1
fi

if [ "$VSIG" != "$csum" ]; then
	echo " Does not match, expected $FSIG, given $csum"
	exit 1
fi

if [ -f $BINFILE ]; then
	echo +++ Backing up old image
	rm -f ${BINFILE}.old
	mv ${BINFILE} ${BINFILE}.old
fi

echo +++ Installing
mv ${TMPDIR}/ffimage.sha256sum ${CSUMFILE} || exit 1
mv ${TMPDIR}/ffimage.bin ${BINFILE} || exit 1

echo +++ Synchronizing nvram
nvsync || exit 1

