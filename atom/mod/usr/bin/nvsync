#!/bin/sh
#
# Synchronize passwords, keys etc. from atom to "nvram"
#

export FFINSTDIR=/usr/local
export FFRITZ_HOME=/var/media/ftp/ffritz
export FFLOG=/var/log/ffritz.log
PATH=$PATH:/usr/bin

DATADIR=$FFRITZ_HOME/data

NVRAM_FILE=$DATADIR/ffstore.dat
BINFILE=$DATADIR/ffimage.bin
PRIVKEY=/var/flash/websrv_ssl_key.pem

NVRAM_COPY=/var/tmp/ffnvram

if [ ! -d $NVRAM_COPY ]; then
	echo 'No NVRAM copy to store ($NVRAM_COPY)' 1>&2
	exit 1
fi

mkdir -p $DATADIR
chmod 700 $DATADIR

## Pack RAM copy into tar file
cd $NVRAM_COPY
tar cf /tmp/ffstore.tar . || exit 1

## encrypt it with the box password
privatekeypassword | openssl enc -pass stdin -salt -aes-256-cbc -in /tmp/ffstore.tar  -out /tmp/ffstore.dat

## move it to persistent storage, overwriting old data file
chmod 700 /tmp/ffstore.dat
mv /tmp/ffstore.dat $NVRAM_FILE || exit 1

echo success
