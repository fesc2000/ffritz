#!/bin/sh
#
# Simple service management
#

. /usr/local/etc/ffritz-env.sh

op=$1
service=$2

cd $NVRAM/etc/rc.d || exit 1

if [ "$op" = "list" ]; then
	echo Available:
	cd ../init.d; ls | sort | sed -e 's/^[0-9]*/    /'
	echo Enabled:
	cd ../rc.d; ls | sort | sed -e 's/^[0-9]*/    /'
	exit 0
fi

if [ -z "$op" -o -z "$service" ]; then
    echo "usage: $0 start|stop|restart|enable|disable|list service"
    exit 1
fi

service_file=`ls $NVRAM/etc/init.d/[0-9]*$service 2>/dev/null`

if [ ! -f "$service_file" ]; then
    echo no such service: $service
    exit 1
fi

service_fname=`basename $service_file`

case $op in
	edit)	tmpfile=/tmp/$$.`basename $service_file`
		cp $service_file $tmpfile || exit 1
		vi $tmpfile || exit 1
		diff $tmpfile $service_file >/dev/null && exit 0
		if [ -L $service_file ]; then
			link=`readlink -f $service_file`
			rm -f $service_file || exit 1
			echo $service_file is modified, future changes from $link are ignored.
		fi
		mv $tmpfile $service_file || exit 1
		;;
	start)	$service_file start || echo $service started;;
	stop)   $service_file stop  || echo $service stopped;;
	enable) ln -sfv ../init.d/$service_fname .; nvsync;;
	disable) rm -fv $NVRAM/etc/rc.d/$service_fname; nvsync;; 
	restart) $service_file stop;
		 sleep 3;
		 $service_file start || echo $service restarted;;
	*)	echo "usage: $0 start|stop|restart|enable|disable|list|edit service";;
esac
