#! /bin/sh
#
# Startup preparations for ffritz on atom.
# Preparations should have been done in /etc/init.d/S91-...
#

. /usr/local/etc/ffritz-env.sh || exit 1

OVERLAY=$NVRAM/rootfs-overlay

touch $FFLOG
chmod 666 $FFLOG

# Prepare etc directory in nvram
# This contains all persistent data in /etc, including rc scripts
#
# It will be used as unionfs overlay to /etc for the buildroot directory
#
# This function is intended for first-time initialization after updating
# to this ff image version. Make sure to stay compatible with a system
# that does not have a ffimage overlay.
#
# shadow:   moves to  rootfs-overlay/etc
# root-ssh: moves to rootfs-overlay/.ssh
#
prep_etcdir()
{
	mod=0

	# check/reate /tmp/ffnvram/rootfs-overlay
	if [ ! -d $OVERLAY ]; then
		mod=1
		mkdir -p $OVERLAY/etc/init.d
		mkdir -p $OVERLAY/etc/rc.d
		mkdir -p $NVRAM/etc
		cd $NVRAM/etc
		mv rc.d rc.d.old
		ln -s ../rootfs-overlay/etc/rc.d .
	fi

	# move/link etc/shadow
	if [ ! -f $OVERLAY/etc/shadow ]; then
		mod=1
		cd $NVRAM
		mv shadow rootfs-overlay/etc/shadow
		ln -s rootfs-overlay/etc/shadow .
	fi

	# move/link roots .ssh
	if [ ! -d $OVERLAY/.ssh ]; then
		mod=1
		mv $NVRAM/root-ssh $OVERLAY/.ssh
		cd $NVRAM
		ln -s rootfs-overlay/.ssh root-ssh
	fi

	# check/install all services
	# XXX should take old .keep files into account...
	for svc in `cd $FFINSTDIR/etc/init.d; ls`; do
		if [ ! -f $OVERLAY/etc/rc.d/$svc -a ! -f $OVERLAY/etc/init.d/$svc ]; then
			mod=1
			cp $FFINSTDIR/etc/init.d/$svc $OVERLAY/etc/init.d/$svc
			chmod +x $OVERLAY/etc/init.d/$svc
			cd $OVERLAY/etc/rc.d/
			ln -s ../init.d/$svc .
		fi
	done

	# make changes persistent
	if [ $mod -ne 0 ]; then
		nvsync
	fi
}


# Start services
#
(
# wait for all FB services to be up ... :-(
# Otherwise trouble with USB, OpenVPN, ...
#
rcsrunning=`ps|grep rc.S|wc -l`
if [ $rcsrunning -gt 1 ]; then
	sleep 100
fi

# Create/check users/paths
#
$FFINSTDIR/etc/mkusers

# Adjust rootfs-overlay if requires
#
prep_etcdir

# Start services
#
cd $NVRAM/etc/rc.d && for svc in `ls|sort`; do
    echo starting $svc
    sh $svc start
done

) | tee -a $FFLOG 2>&1 &

