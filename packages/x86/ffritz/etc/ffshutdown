#!/bin/sh
#
# Hack to stop ffritz daemons and unmount /usr/local

if [ `readlink -f $0` != /var/tmp/ffshutdown ]; then
	cp -f $0 /var/tmp/ffshutdown
	exec /var/tmp/ffshutdown
fi

ffdaemon -K %all
busybox lsof -p `pidof cableinfo`|grep libdvbfi > /dev/null && killall cableinfo

if [ -f /var/media/ftp/ffritz/.mtab ]; then
	/usr/local/etc/usrmount -u /var/media/ftp/ffritz/.mtab >/dev/null 2>&1
fi
sleep 2

pids=`busybox lsof | grep /usr/local | sort -u |sed -e 's/[^0-9].*//'`
if [ "$pids" != "" ]; then
	echo +++ stopping PIDs $pids
	kill $pids
fi

sleep 2
pids=`busybox lsof | grep /usr/local | sort -u |sed -e 's/[^0-9].*//'`
if [ "$pids" != "" ]; then
	echo killing PIDs $pids
	kill -9 $pids
	sleep 2
fi

mount|grep /usr/local >/dev/null

if [ $? -eq 0 ]; then
	umount /usr/local
	if [ $? -ne 0 ]; then
		echo FAILED to unmount /usr/local 1>&2
		exit 1
	fi
fi
