#!/bin/sh
#
# Hack to stop ffritz daemons and unmount /usr/local

if [ `readlink -f $0` != /var/tmp/ffshutdown ]; then
	cp -f $0 /var/tmp/ffshutdown
	exec /var/tmp/ffshutdown
fi

ffdaemon -K %all
busybox lsof -p `pidof cableinfo`|grep libdvbfi > /dev/null && killall cableinfo

if [ -f /var/media/ftp/ffritz/.mtab ]; then
	/usr/local/etc/usrmount -u /var/media/ftp/ffritz/.mtab >/dev/null 2>&1
fi
sleep 5

umount /usr/local && exit 0

echo Some processes still access /usr/local:
busybox lsof | grep /usr/local | sort -u

exit 1
