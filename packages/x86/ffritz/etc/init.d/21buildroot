#!/bin/sh
#

BR_DIR=/tmp/br
BR_OVERLAY=/tmp/ffnvram/rootfs-overlay
DEV_OVERLAY=/tmp/br-dev
BR_ROOT=/usr/local/buildroot

if [ "x$1" = "xstop" ]; then
	umount $BR_DIR
	exit 0
fi

if [ ! -d $BR_OVERLAY ]; then
	echo buildroot overlay does not exist: $BR_OVERLAY
	exit 1
fi

if [ ! -d $BR_ROOT ]; then
	echo buildroot root image directory does not exist: $BR_ROOT
	exit 1
fi

if [ -d $BR_OVERLAY/proc/self ]; then
	echo $BR_OVERLAY directory is not clean
	exit 1
fi

# create an intermediate layer for all special filesystems
# can't create it in rootfs-overlay, otherwise nvsync will attempt
# to save them
#
mkdir -p $BR_DIR
mkdir -p $DEV_OVERLAY/proc
mount -t proc none $DEV_OVERLAY/proc
mount -t usbfs none $DEV_OVERLAY/proc/bus/usb
mkdir -p $DEV_OVERLAY/dev
mount -t devtmpfs none $DEV_OVERLAY/dev
mkdir -p $DEV_OVERLAY/sys
mount -t sysfs none $DEV_OVERLAY/sys

unionfs -o cow,dev,suid,allow_other $BR_OVERLAY=RW:$DEV_OVERLAY=RW:$BR_ROOT=RO $BR_DIR

exit $?
