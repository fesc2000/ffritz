#!/bin/sh
# Xfeature:getconfig
#        
# wireguard startup file
#                   
. /usr/local/etc/ffritz-env.sh || exit 1


WGDIR=$NVRAM/etc/wireguard

if [ "x$1" = "xgetconfig" ]; then
	exit 0
fi

if [ "x$1" = "xinfo" ]; then
	echo DAEMONS=\"wgforward\"
	/sbin/ifconfig wg0 >/dev/null 2>&1
	if [ $? -eq 0 ]; then
		echo STATUS=on
	else
		echo STATUS=off
	fi
	exit 0
fi

if [ `echo $CONFIG_VERSION | tr -d '.'` -gt 712 ]; then
	echo 'Sorry, wireguard will not yet run on firmware > 7.12' 1>&2
	echo 'Sorry, wireguard will not yet run on firmware > 7.12' > /dev/console
	exit 0
fi


if [ "x$1" = "xstop" ]; then
	ffdaemon -K wgforward
	wg-quick down $WGDIR/wg0.conf
#	rmmod wireguard
	exit 0
fi

if [ "x$1" != "xstart" ]; then
	exit 0
fi

if [ ! -f $WGDIR/wg0.conf ]; then
	echo WireGuard not started, no config file
	exit 0
fi

module=$FFINSTDIR/lib/modules/`uname -r`/wireguard.ko

if [ ! -r $module ]; then 
	echo $module not present
	exit 1
fi

lanip=169.254.1.1
# lanip=`/sbin/ifconfig lan|grep 'inet addr:'|sed -e 's/.*inet addr:\(.*\) B.*/\1/'`
test -z $lanip && exit 1

insmod $module

# run pcplisten periodically to add/renew a forward rule to wireguard
#
ffdaemon -i 90 -N wgforward pcplisten udp $lanip 51820 100 wg

wg-quick up $WGDIR/wg0.conf
