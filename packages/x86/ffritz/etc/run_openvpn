#!/bin/sh
#        
# lircd startup file
#                   
. `dirname $0`/../etc/ffritz-env.sh || exit 1
                                             
if [ ! -d $FFRITZ_HOME/etc/openvpn ]; then
    cp -ar $FFINSTDIR/etc/openvpn $FFRITZ_HOME/etc
fi

if [ ! -f $FFRITZ_HOME/etc/openvpn/openvpn.conf ]; then
	echo OpenVPN not started, no config file
	exit 0
fi

# Create lan:1 so that a forwarding rule for the Atom core can be set up
# IP is one below the lan IP
#
lanip=`/sbin/ifconfig lan|grep 'inet addr:'|sed -e 's/.*inet addr:\(.*\) B.*/\1/'`
net=`echo $lanip | sed -e 's/\([0-9]*\.[0-9]*\.[0-9]*\).*/\1/'`
addr=`echo $lanip | sed -e 's/[0-9]*\.[0-9]*\.[0-9]*\.\(.*\)/\1/'`

test -z $lanip && exit 1
test -z $net && exit 1
test -z $addr && exit 1

naddr=`expr $addr - 1`
nip=${net}.${naddr}

/sbin/ifconfig lan:1 $nip || exit 1
echo $0: $nip assigned to lan1:1 >> $FFLOG


$FFINSTDIR/bin/openvpn --daemon --writepid /var/run/openvpn.openvpn.pid --config $FFRITZ_HOME/etc/openvpn/openvpn.conf --cd $FFRITZ_HOME/etc/openvpn --script-security 2
