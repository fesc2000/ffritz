#!/bin/sh
#
# Wrapper to call mpd with the proper libraries and config file
# Never returns, should be called with nohup
#
. `dirname $0`/../etc/ffritz-env.sh || exit 1

$FFINSTDIR/etc/mkusers || exit 1

# Make sure usbplayd runs
#
$FFINSTDIR/etc/run_usbplay

# generate mpd.conf from template
#
if [ ! -f $FFRITZ_HOME/mpd.conf ]; then
    sed -e "s@FFINSTDIR@$FFINSTDIR@" < $FFINSTDIR/etc/mpd.conf > $FFRITZ_HOME/mpd.conf
fi
sed -i -e "s@\(.*\"\).*\(/bin/usbplay.*\)@\1$FFINSTDIR\2@" $FFRITZ_HOME/mpd.conf
chown ffritz:ffritz $FFRITZ_HOME/mpd.conf

# Run mpd in endless loop in case it crashes
#
nohup $FFINSTDIR/bin/su ffritz $FFINSTDIR/etc/mpdloop&
