From 502cf74e0df0030060ff1122e66943dc17ffa485 Mon Sep 17 00:00:00 2001
From: Felix Schmidt <fesc2000@gmail.com>
Date: Mon, 31 Aug 2020 16:01:11 +0200
Subject: [PATCH] Add volume control file for audio_pipe

---
 audio_pipe.c | 45 ++++++++++++++++++++++++++++++++++++++++++++-
 1 file changed, 44 insertions(+), 1 deletion(-)

diff --git a/audio_pipe.c b/audio_pipe.c
index 45e0f06..762ba33 100644
--- a/audio_pipe.c
+++ b/audio_pipe.c
@@ -42,6 +42,36 @@
 static int fd = -1;
 
 char *pipename = NULL;
+static char *volname = NULL;
+int warned = 0;
+
+// ffritz: volume handling via file
+static double minDb = (double)-64.0;
+static double maxDb = (double)0.0;
+
+extern audio_output audio_pipe;
+
+static void volume(double vol)
+{
+    FILE *fh;
+    double nvol = ((vol - minDb) / (maxDb - minDb)) * (double)100.0;
+
+    if (!volname)
+	return;
+
+    fh = fopen(volname, "w");
+    if (!fh)
+	return;
+
+    fprintf (fh, "%d", (int)nvol);
+
+    fclose (fh);
+}
+
+static void parameters(audio_parameters *info) {
+  info->minimum_volume_dB = (int)minDb;
+  info->maximum_volume_dB = (int)maxDb;
+}
 
 static void start(__attribute__((unused)) int sample_rate,
                   __attribute__((unused)) int sample_format) {
@@ -85,6 +115,13 @@ static int play(void *buf, int samples) {
 
 static void stop(void) {
   // Don't close the pipe just because a play session has stopped.
+  // ffritz: yes, do it, because we want to switch to previous input 
+  // on usbplayd
+  //
+  if (fd > 0)
+    close(fd);
+
+  fd = -1;
 
 }
 
@@ -111,6 +148,12 @@ static int init(int argc, char **argv) {
 
     if ((pipename) && (strcasecmp(pipename, "STDOUT") == 0))
       die("Can't use \"pipe\" backend for STDOUT. Use the \"stdout\" backend instead.");
+
+    if (config_lookup_string(config.cfg, "pipe.volume", &str)) {
+      volname = (char *)str;
+      audio_pipe.volume = &volume;
+      audio_pipe.parameters = &parameters;
+    }
   }
 
   if ((pipename == NULL) && (argc != 1))
@@ -149,5 +192,5 @@ audio_output audio_pipe = {.name = "pipe",
                            .delay = NULL,
                            .play = &play,
                            .volume = NULL,
-                           .parameters = NULL,
+                           .parameters = &parameters,
                            .mute = NULL};
-- 
2.17.1

